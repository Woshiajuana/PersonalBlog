"use strict";var _extends=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},fs=require("fs-extra"),path=require("path"),out=require("wow-cmd").output,cmdPath=process.cwd(),Client=require("ftp"),co=require("co"),prompt=require("co-prompt"),Handle=function(t,r,e){var n=t.params;n=n?n.toLocaleLowerCase():"";try{var o={host:"49.233.210.236",port:"21",user:"ftp"};n&&(o=Object.assign(o,require(path.join(cmdPath,n)).default));var c=o,i=c.rootDir,s=c.password,u=c.entryDir;if(u&&(u=path.join(cmdPath,u),r=[],function t(e){fs.readdirSync(e).forEach(function(n){var o=path.join(e,n),c=fs.statSync(o),i=o.replace(u,"").replace(/\\/g,"/"),s=i.split("/"),a=s[s.length-1];c.isFile()?(s.shift(),r.push({input:o,output:""+i.substring(1)})):c.isDirectory()&&-1===[].indexOf(a)&&t(o)})}(u)),!r)throw"未指定上传文件";co(regeneratorRuntime.mark(function t(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(i){t.next=4;break}return t.next=3,prompt("\n请输入上传根目录(不要斜杆开头结尾): ");case 3:i=t.sent;case 4:if(-1!==["jianyi","ajuan","tiaotiao"].indexOf(i)){t.next=7;break}return out.error("ftp.cmd=>","上传根目录错误"),t.abrupt("return",process.exit(0));case 7:if(s){t.next=11;break}return t.next=10,prompt("\n请输入FTP密码: ");case 10:s=t.sent;case 11:e=new Client,e.connect(_extends({},o,{password:s,rootDir:i}));try{e.on("ready",function(){var t=void 0;(t=function(r,n){var o=r[n]||{},c=o.input,s=o.output;if(!c||!s)return e.end(),out.success("ftp.cmd=>","全部上传完毕"),process.exit(0),null;s="blog/"+i+"/"+s;var u=s.substr(0,s.lastIndexOf("/"));e.get(u,function(o){o?e.mkdir(u,!0,function(o){if(o)return out.error("ftp.cmd=>","创建文件夹："+u+" 失败：",o),null;e.put(c,s,function(e){e?out.error("ftp.cmd=>","上传文件："+c+" 失败：",e):out.success("ftp.cmd=>","上传文件："+c+" 成功"),n++,t(r,n)})}):e.put(c,s,function(e){e?out.error("ftp.cmd=>","上传文件："+c+" 失败：",e):out.success("ftp.cmd=>","上传文件："+c+" 成功"),n++,t(r,n)})})})(r,0)}),e.on("error",function(t){out.error("ftp.cmd=>","上传错误："+t),e.end(),process.exit(0)}),e.on("close",function(t){out.info("ftp.cmd=>","上传关闭："+t),e.end()})}catch(t){e.end(),process.exit(0)}case 14:case"end":return t.stop()}},t,this)})())}catch(t){out.error("ftp.cmd=>","上传错误："+t)}finally{e()}};Handle.options={cmd:["-f","--ftp"]},module.exports=Handle;
