"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},fs=require("fs-extra"),path=require("path"),out=require("wow-cmd").output,cmdPath=process.cwd(),Client=require("ftp"),co=require("co"),prompt=require("co-prompt"),crypto=require("crypto"),Handle=function(t,e,r){var n=t.params;n=n?n.toLocaleLowerCase():"";try{var o={host:"49.233.210.236",port:"21",user:"ftp"};n&&(o=Object.assign(o,require(path.join(cmdPath,n)).default));var c={},i=o,s=i.rootDir,u=i.password,a=i.entryDir;a&&(a=path.join(cmdPath,a),e=[],function t(r){fs.readdirSync(r).forEach(function(n){var o=path.join(r,n),i=fs.statSync(o),s=o.replace(a,"").replace(/\\/g,"/"),u=s.split("/"),p=u[u.length-1];if(i.isFile()){u.shift();var f=""+s.substring(1),d=fs.readFileSync(o),l=crypto.createHash("md5").update(d).digest("hex");e.push({input:o,output:f,md5:l}),c[f]=l}else i.isDirectory()&&-1===[].indexOf(p)&&t(o)})}(a));var p={};try{p=require("./md5.json")}catch(t){}if(!(e=e.filter(function(t){return t.md5!==p[t.output]})))throw"未指定上传文件";co(regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(s){t.next=4;break}return t.next=3,prompt("\n请输入上传根目录(不要斜杆开头结尾): ");case 3:s=t.sent;case 4:if(-1!==["jianyi","ajuan","tiaotiao"].indexOf(s)){t.next=7;break}return out.error("ftp.cmd=>","上传根目录错误"),t.abrupt("return",process.exit(0));case 7:if(u){t.next=11;break}return t.next=10,prompt("\n请输入FTP密码: ");case 10:u=t.sent;case 11:r=new Client,r.connect(_extends({},o,{password:u,rootDir:s}));try{r.on("ready",function(){var t=void 0;(t=function(e,n){var o=e[n]||{},i=o.input,u=o.output,a=u;if(!i||!u)return r.end(),fs.writeFileSync(cmdPath+"/cmd/md5.json",JSON.stringify(c,null,4)),out.success("ftp.cmd=>","全部上传完毕"),process.exit(0),null;u="blog/"+s+"/"+u;var p=u.substr(0,u.lastIndexOf("/"));r.get(p,function(o){o?r.mkdir(p,!0,function(o){if(o)return out.error("ftp.cmd=>","创建文件夹："+p+" 失败：",o),null;r.put(i,u,function(r){r?(delete c[a],out.error("ftp.cmd=>","上传文件："+i+" 失败：",r)):out.success("ftp.cmd=>","上传文件："+i+" 成功"),n++,t(e,n)})}):r.put(i,u,function(r){r?(delete c[a],out.error("ftp.cmd=>","上传文件："+i+" 失败：",r)):out.success("ftp.cmd=>","上传文件："+i+" 成功"),n++,t(e,n)})})})(e,0)}),r.on("error",function(t){out.error("ftp.cmd=>","上传错误："+t),r.end(),process.exit(0)}),r.on("close",function(t){out.info("ftp.cmd=>","上传关闭："+t),r.end()})}catch(t){r.end(),process.exit(0)}case 14:case"end":return t.stop()}},t,this)})())}catch(t){out.error("ftp.cmd=>","上传错误："+t)}finally{r()}};Handle.options={cmd:["-f","--ftp"]},module.exports=Handle;
